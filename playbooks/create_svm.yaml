---
- name: create svm  
  hosts: "localhost"
  become: no 
  gather_facts: no
  vars:
    cluster: "{{ vars[copy].cluster }}"
    svm: "{{ vars[copy].svm }}"
    lifs: "{{ vars[copy].lifs }}"
    newsvm: "{{ services[general.service][general.company][general.environment][general.location][copy]['newsvm'] }}"

    clusterauth:  &login
      hostname: "{{ cluster }}"
      username: "{{ login.user }}"
      password: "{{ login.password }}"
      https: true
      validate_certs: false

  vars_files:
  #- volume_variables.yaml
  - ../globals.yaml

  collections:
  - netapp.ontap  

  tasks:

    # log  infomration 
    - name: svm creation info
      ansible.builtin.debug:
        msg:
        - "creating svm:{{ cluster }}:{{ svm }} copy:{{ copy }}"  

    - name: Create SVM
      netapp.ontap.na_ontap_svm:
        state: present
        name: "{{ svm }}"
        #set svm allowed protocols 
        allowed_protocols: "{{ newsvm.allowed_protocols | default(omit) }}"           
        #set SVM lanaguage 
        language: "{{ newsvm.language | default(omit) }}"
        #root volume security style 
        root_volume_security_style: "{{ newsvm.root_volume_security_style | default(omit) }}"
        <<: *login

    - name: Create data interface  -> loop
      netapp.ontap.na_ontap_interface:
        state: present
        role: data
        interface_name: "{{ svm }}_data_lif_{{ idx + 1 }}"
        home_port: "{{ item.port }}"
        home_node: "{{ item.node }}"
        admin_status: up
        is_auto_revert: true
        interface_type: ip
        address: "{{ item.ip }}"
        netmask: "{{ item.netmask }}"
        vserver: "{{ svm }}"
        <<: *login
      loop: "{{ lifs }}" 
      loop_control:
        index_var: idx  
