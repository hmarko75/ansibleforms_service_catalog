categories:
  - name: Default
    icon: bars
  - name: Provision
    icon: bath
  - name: Maintenance
    icon: bath
roles:
  - name: admin
    groups:
      - local/admins
      - ldap/Domain Admins
  - name: operator
    groups:
      - local/operator
  - name: demo
    groups:
      - local/demo
  - name: public
    groups: []
  - name: Provision
    groups:
      - local/Provision Admins
constants: {}
forms:
  - name: Cleanup Ansibleforms Jobs
    showHelp: true
    help: |
      This form starts the `ansibleforms_job_cleanup.yaml` playbook
      It will remove all ansible job logs
    roles:
      - admin
    description: This will cleanup all ansible job logs.
    icon: trash
    categories:
      - Maintenance
    tileClass: has-background-danger-light
    playbook: ansibleforms_job_cleanup.yaml
    type: ansible
    fields:
      - type: expression
        name: mysql_credential
        expression: "'__self__'"
        label: Credential to connect to database
        asCredential: true
        required: true
        hide: true
      - type: checkbox
        name: areyousure
        label: Confirmation
        default: false
        placeholder: Are you sure you want to cleanup
        required: true
      - type: text
        name: confirmation
        label: Please type YES to confirm you want to cleanup
        placeholder: YES
        required: true
        regex:
          expression: ^YES$
          description: Type YES to confirm
        dependencies:
          - name: areyousure
            values:
              - true
  - name: Debug
    help: Debug
    roles:
      - Provision
    description: Debug
    categories:
      - Provision
    icon: scroll
    playbook: debug.yaml
    inventory: hosts
    type: ansible
    fields:
      - type: expression
        name: settings
        label: settings
        expression: fn.fnReadYamlFile('/app/dist/persistent/globals.yaml','')
        noOutput: true
        hide: true
      - type: expression
        name: aiqum
        label: aiqum
        expression: fn.fnJq($(settings),'.general.aiqum')
        hide: true
      - type: expression
        name: aiqumlogin
        label: aiqumlogin
        expression: "'AIQUM'"
        asCredential: true
        hide: true
      - type: expression
        name: ontaplogin
        label: ontaplogin
        expression: "'ONTAP'"
        asCredential: true
        hide: true   

      - type: expression
        name: decomissioned_vols
        label: decomissioned_vols
        dbConfig:
          name: AIQUMSQL
          type: mysql
        query: select CONCAT(cluster.name,':',vserver.name,':',volume.name) as 'Cluster:SVM:Volume',
          CONCAT(format(round(volume.size/1024/1024/1024,0),'T0'),'G') as Size,
          round(volume.size/1024/1024/1024,0) as sizeg,
          CONCAT(format(round(volume.sizeUsed/1024/1024/1024,0),'T0'),'G') as Used,
          volume.sizeUsed/volume.size as Utilization, cluster.name as cluster,
          vserver.name as svm, volume.name as volume 
          from netapp_model_view.cluster, netapp_model_view.vserver, netapp_model_view.volume 
          where volume.vserverid = vserver.objid and vserver.clusterid = cluster.objid and volume.state =
          'OFFLINE' and volume.isVserverRoot = 0 and vserver.type='DATA' and vserver.subtype='DEFAULT' 
          and volume.name like "%_to_be_deleted_after_%"
          order by volume.name
        hide: false      
        
      - type: query
        name: expiredvolume
        label: The following decommissioned volumes are ready to be deleted
        multiple: true
        expression: fn.fnJq($(decomissioned_vols),'[.[]|.|=.+{expiry:.volume| sub(".+to_be_deleted_after_";"")|gsub("_";"/")|strptime("%d/%m/%Y")|mktime}+{now:now}+{"Expiry Date":.volume| sub(".+to_be_deleted_after_";"")|gsub("_";"/")}+{"Original Volume":.volume| sub("_to_be_deleted_after_.+";"")}|select(.expiry<now+1000000)]')
        columns:
          - Cluster:SVM:Volume
          - Original Volume
          - Expiry Date
        required: true
        default: __none__
        outputObject: true
        model: volumes
        #sticky: true
        #noOutput: true
