---
- name: clone dataset
  hosts: "{{ general.dataopshost }}"
  become: no 
  gather_facts: no
  tasks:
  - name: create clone 
    command: "{{ general.dataopscli }} clone volume --cluster={{ cluster }} --source-svm={{ source.svm }} --target-svm={{ clone.svm }} --name={{ clone.volume }} --source-volume={{ source.volume }} --source-snapshot={{ source.snapshot }} {{ ('--junction='+clone.junctionpath if clone.junctionpath != '')|default('') }} {{ (' --export-hosts='+clone.exporthosts if clone.exporthosts != '')|default('') }} {{ (' -d ' if clone.svm_dr_unprotect is defined)|default('') }} {{ (' -i '+clone.snapshotpolicy if clone.snapshotpolicy)|default('') }} {{ (' --split ' if split)|default('') }}"
    register: out
    when: not clonerefresh
  - debug: var=out.stdout_lines
    when: not clonerefresh  
  - debug: var=out.stderr_lines  
    when: not clonerefresh 

  - name: create clone protection 
    command: "{{ general.dataopscli }} clone volume --cluster={{ protection.cluster }} --source-svm={{ protection.basesvm }} --target-svm={{ protection.svm }} --name={{ protection.volume }} --source-volume={{ protection.basevol }} --source-snapshot={{ source.snapshot }} {{ ('--junction='+clone.junctionpath if clone.junctionpath != '')|default('') }} {{ (' --export-hosts='+clone.exporthosts if clone.exporthosts != '')|default('')}} {{(' -d ' if clone.svm_dr_unprotect is defined)|default('')}} {{(' --split ' if split)|default('')}}"
    register: out
    when: not clonerefresh and protection is defined 
  - debug: var=out.stdout_lines
    when: not clonerefresh and protection is defined 
  - debug: var=out.stderr_lines  
    when: not clonerefresh and protection is defined 

  - name: resync snapmirror between clones  
    command: "{{ general.dataopscli }} create snapmirror-relationship --cluster-name={{ protection.cluster }} --source-svm={{ clone.svm }} --target-svm={{ protection.svm }} --source-vol={{ clone.volume }} --target-vol={{ protection.volume }} --schedule={{ protection.schedule }} --policy={{ protection.policy }} --action=resync"
    register: out
    when: not clonerefresh and protection is defined 
  - debug: var=out.stdout_lines
    when: not clonerefresh and protection is defined  
  - debug: var=out.stderr_lines  
    when: not clonerefresh and protection is defined 

  - name: refresh clone 
    command: "{{ general.dataopscli }} clone volume --cluster={{ cluster }} --source-svm={{ source.svm }} --target-svm={{ clone.svm }} --name={{ clone.volume }} --source-volume={{ source.volume }} --source-snapshot={{ source.snapshot }} --refresh {{(' -d ' if clone.svm_dr_unprotect)|default('')}} {{(' --split ' if split)|default('')}}"
    register: out
    when: clonerefresh    
  - debug: var=out.stdout_lines
    when: clonerefresh   
  - debug: var=out.stderr_lines 
    when: clonerefresh   

